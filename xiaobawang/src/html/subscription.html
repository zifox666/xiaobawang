<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMËÆ¢ÈòÖÁÆ°ÁêÜ - Â∞èÈú∏Áéã</title>
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="/static/css/subscription.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app">
        <!-- ÁôªÂΩïÈ°µÈù¢ -->
        <div v-if="!isLoggedIn" class="login-container">
            <div class="login-box">
                <div class="login-title">EVEÂ∞èÈú∏ÁéãKMËÆ¢ÈòÖÁÆ°ÁêÜ</div>
                
                <el-form :model="form">
                    <el-form-item label="TOKEN">
                        <el-input v-model="form.token" placeholder=""></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="login" :loading="loginLoading" style="width: 100%">ÁôªÂΩï</el-button>
                    </el-form-item>
                </el-form>
                
                <!-- Â∏ÆÂä©ÊèêÁ§∫ -->
                <div class="mt-8 pt-5 border-t border-gray-200 text-center">
                    <div class="mb-3 text-gray-500 text-sm font-medium">‰∏çÁü•ÈÅìÊÄé‰πàËé∑Âèñ TOKEN?</div>
                    <el-tooltip 
                        :content="`ÁßÅËÅäÊú∫Âô®‰∫∫ÂèëÈÄÅ‰∏ãÈù¢ÁöÑÂëΩ‰ª§,Â¶ÇÊûúÊÉ≥ËÆ¢ÈòÖÁßÅËÅä,‰∏çÈúÄË¶ÅÂ°´ÂÜô QQ Áæ§Âè∑`" 
                        placement="top">
                        <div class="inline-block bg-gray-50 px-3 py-2 rounded text-gray-700 font-mono text-sm mb-2 cursor-help">
                            /get_sub_token [qqÁæ§Âè∑]
                        </div>
                    </el-tooltip>
                </div>
            </div>
        </div>
        
        <!-- ‰∏ªÁïåÈù¢ -->
        <div v-else class="w-full min-h-screen bg-gray-100">
            <!-- ‰∏ªÂÆπÂô® -->
            <div class="container-main">
                <div class="header-section">
                    <div>
                        <h1 style="font-size: 28px; margin-bottom: 10px;">KM ËÆ¢ÈòÖÁÆ°ÁêÜ - Â∞èÈú∏Áéã</h1>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #ddd; margin-bottom: 8px;">ÂΩìÂâçÁî®Êà∑[{{user.platform}}]{{user.userId}}</div>
                        <div style="font-size: 18px; font-weight: bold;">[{{user.sessionType}}]{{user.sessionId}}</div>
                        <el-button type="danger">ÁôªÂá∫</el-button>
                    </div>
                </div>
                
                <!-- ÁªüËÆ°Âç°Áâá -->
                <div style="padding: 24px; border-bottom: 1px solid #eee;">
                    <div class="grid grid-cols-5 gap-4">
                        <div class="stat-card">
                            <div class="stat-value">{{ stats.total }}</div>
                            <div class="stat-label">ÊÄªËÆ¢ÈòÖÊï∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #67c23a;">{{ stats.enabled }}</div>
                            <div class="stat-label">Â∑≤ÂêØÁî®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #f56c6c;">{{ stats.disabled }}</div>
                            <div class="stat-label">Â∑≤Á¶ÅÁî®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #e6a23c;">{{ stats.total }}</div>
                            <div class="stat-label">ÊÄªÊï∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">Free</div>
                            <div class="stat-label">ÂΩìÂâç‰ΩôÈ¢ù</div>
                        </div>
                    </div>
                </div>
                
                <!-- Êìç‰ΩúÊ†è -->
                <div style="padding: 20px 24px; border-bottom: 1px solid #eee; background: #f5f7fa;">
                    <div style="display: flex; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; gap: 12px;">
                            <el-button type="primary" @click="showCreate = true; editingId = null; resetSubForm()">+ Êñ∞Âª∫ËÆ¢ÈòÖ</el-button>
                            <el-button @click="refreshList" :loading="loading">Âà∑Êñ∞</el-button>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <el-select v-model="filterEnabled" placeholder="Á≠õÈÄâÁä∂ÊÄÅ" style="width: 120px" clearable @change="refreshList">
                                <el-option label="Â∑≤ÂêØÁî®" :value="true" ></el-option>
                                <el-option label="Â∑≤Á¶ÅÁî®" :value="false"></el-option>
                            </el-select>
                            <el-input v-model="searchText" placeholder="ÊêúÁ¥¢..." style="width: 200px" clearable></el-input>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ¢ÈòÖÂàóË°® -->
                <div style="padding: 24px;">
                    <el-table :data="filteredSubs" stripe v-loading="loading" style="width: 100%;">
                        <el-table-column fixed prop="name" label="ÂêçÁß∞" ></el-table-column> 
                        <el-table-column label="ÈÄªËæë" width="80" align="center">
                            <template #default="{ row }">
                                <el-tag type="info">{{ row.condition_groups?.logic || 'AND' }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="Êù°‰ª∂ËØ¶ÊÉÖ" min-width="280">
                            <template #default="{ row }">
                                <div v-if="row.condition_groups?.conditions?.length">
                                    <div v-for="(c, i) in row.condition_groups.conditions" :key="i" style="font-size: 12px; color: #606266; margin-bottom: 4px;">
                                        {{ summarizeConditionWrapper(c) }}
                                    </div>
                                </div>
                                <span v-else style="color:#909399;">Êó†</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="ÁßØÂàÜÂÄçÁéá" width="110" align="center">
                            <template #default="{ row }">
                                <div style="font-weight: 600; color: #409eff;">x{{ calcRuleMultiplierWrapper(row.condition_groups).toFixed(2) }}</div>
                            </template>
                        </el-table-column>
                        <el-table-column label="Êé®ÈÄÅÊúÄ‰ΩéÈòàÂÄº" width="120" align="center">
                            <template #default="{ row }">
                                {{ (row.min_value / 1e9).toFixed(2) }}‰∫ø ISK
                            </template>
                        </el-table-column>
                        <el-table-column label="Êù°‰ª∂Êï∞" width="80" align="center">
                            <template #default="{ row }">
                                <el-tag>{{ getConditionCount(row.condition_groups) }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="Áä∂ÊÄÅ" width="80" align="center">
                            <template #default="{ row }">
                                <el-tag :type="row.is_enabled ? 'success' : 'info'">
                                    {{ row.is_enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="Êìç‰Ωú" width="150" align="center" fixed="right">
                            <template #default="{ row }">
                                <el-button link type="primary" @click="editSub(row)">ÁºñËæë</el-button>
                                <el-button link type="danger" @click="delSub(row)">Âà†Èô§</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>
        </div>
        
        <!-- ÂàõÂª∫/ÁºñËæëÂØπËØùÊ°Ü -->
        <el-dialog v-model="showCreate" :title="editingId ? 'ÁºñËæëËÆ¢ÈòÖ' : 'Êñ∞Âª∫ËÆ¢ÈòÖ'" width="900px" @close="resetSubForm">
            <el-scrollbar style="height: 600px">
                <div style="padding-right: 20px;">
                    <!-- Âü∫Á°Ä‰ø°ÊÅØ -->
                    <el-divider>Âü∫Á°Ä‰ø°ÊÅØ</el-divider>
                    <el-form :model="subForm" label-width="120px">
                        <el-form-item label="ÂêçÁß∞">
                            <el-input v-model="subForm.name" placeholder="ÁªôËøô‰∏™ËÆ¢ÈòÖËµ∑‰∏™ÂêçÂ≠ó"></el-input>
                        </el-form-item>
                        <el-form-item label="ÊèèËø∞" v-show="false">
                            <el-input v-model="subForm.description" type="textarea" rows="2"></el-input>
                        </el-form-item>
                        <el-form-item label="Êé®ÈÄÅÊúÄ‰ΩéÈòàÂÄº">
                            <el-input 
                                v-model="minValueInput.formatted" 
                                placeholder="ËØ∑ËæìÂÖ•ÈáëÈ¢ù" 
                                @input="minValueHandler.handleInput" 
                                @blur="minValueHandler.handleBlur"
                                style="width: 100%">
                            </el-input>
                        </el-form-item>
                        <el-form-item label="ÂêØÁî®">
                            <el-switch v-model="subForm.is_enabled"></el-switch>
                        </el-form-item>
                        
                        <!-- ‰ΩøÁî®Ê®°Êùø -->
                        <el-form-item label="Âø´ÈÄüÊ®°Êùø">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <el-button
                                    v-for="tpl in templates"
                                    :key="tpl.key || tpl.name"
                                    :title="tpl.description"
                                    @click="applyTemplate(tpl)">
                                    üìã {{ tpl.name }}
                                </el-button>
                                <span v-if="!templates.length" style="color: #909399; font-size: 12px;">ÊöÇÊó†ÂèØÁî®Ê®°Êùø</span>
                            </div>
                        </el-form-item>
                    </el-form>
                    
                    <!-- Êù°‰ª∂ÁªÑ -->
                    <el-divider>Á≠õÈÄâÊù°‰ª∂</el-divider>
                    <el-form label-width="120px">
                        <el-form-item label="ÈÄªËæë">
                            <el-select v-model="subForm.condition_groups.logic" style="width: 150px">
                                <el-option label="ÂÖ®ÈÉ®ÂåπÈÖç (AND)" value="AND" key="AND"></el-option>
                                <el-option label="‰ªªÊÑèÂåπÈÖç (OR)" value="OR" key="OR"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-form>
                    
                    <!-- Êù°‰ª∂ÂàóË°® -->
                    <div v-if="subForm.condition_groups.conditions.length === 0" style="text-align: center; color: #909399; padding: 20px;">
                        ÊöÇÊó†Êù°‰ª∂ (ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†)
                    </div>
                    
                    <div v-for="(cond, idx) in subForm.condition_groups.conditions" :key="idx" class="condition-item">
                        <div class="condition-type-badge">{{ getCondTypeLabel(cond.type) }}</div>
                        <div style="flex: 1;">
                            <!-- EntityÊù°‰ª∂ -->
                            <div v-if="cond.type === 'entity'" style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px;">
                                <el-select v-model="cond.entity_type" placeholder="ÂÆû‰ΩìÁ±ªÂûã">
                                    <el-option v-for="t in ENTITY_TYPES" :key="t.value" :label="`${t.label} (x${scoreRules.entity_scores[t.value] || 1})`" :value="t.value" ></el-option>
                                </el-select>
                                <el-autocomplete 
                                    v-model="cond.entity_name" 
                                    :fetch-suggestions="queryEntityWrapper"
                                    placeholder="ËæìÂÖ•ÂÆû‰ΩìÂêçÁß∞(Â§ß‰∫é2‰∏™Â≠óÁ¨¶)"
                                    @select="handleEntitySelect($event, cond)"
                                    style="width: 100%">
                                    <template #default="{ item }">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <img :src="item.image" style="width: 24px; height: 24px;" />
                                            <div>
                                                <div>{{ item.name }}</div>
                                                <div style="font-size: 12px; color: #909399;">#{{ item.id }} ({{ item.type }})</div>
                                            </div>
                                        </div>
                                    </template>
                                </el-autocomplete>
                                <el-select 
                                    v-if="['character', 'corporation', 'alliance'].includes(cond.entity_type)" 
                                    v-model="cond.role" 
                                    placeholder="ËßíËâ≤">
                                    <el-option v-for="r in ENTITY_ROLES" :key="r.value" :label="r.label" :value="r.value" ></el-option> 
                                </el-select>
                                <el-select 
                                    v-else-if="cond.entity_type === 'ship'" 
                                    v-model="cond.ship_role" 
                                    placeholder="Ëà∞ËàπËßíËâ≤">
                                    <el-option v-for="r in SHIP_ROLES" :key="r.value" :label="r.label" :value="r.value" ></el-option>
                                </el-select>
                                <div v-else></div>
                            </div>
                            
                            <!-- ValueÊù°‰ª∂ -->
                            <div v-else-if="cond.type === 'value'" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #606266;">ÊúÄÂ∞è‰ª∑ÂÄº (ISK)</label>
                                    <el-input 
                                        :model-value="formatNumberWithComma(cond.min || 0)"
                                        @input="value => { cond.min = parseNumberWithComma(value); }"
                                        placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ∞è‰ª∑ÂÄº"
                                        style="width: 100%">
                                    </el-input>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #606266;">ÊúÄÂ§ß‰ª∑ÂÄº (ISK)</label>
                                    <el-input 
                                        :model-value="formatNumberWithComma(cond.max || 0)"
                                        @input="value => { cond.max = parseNumberWithComma(value); }"
                                        placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ§ß‰ª∑ÂÄº"
                                        style="width: 100%">
                                    </el-input>
                                </div>
                            </div>
                            
                            <!-- LabelÊù°‰ª∂ -->
                            <div v-else-if="cond.type === 'label'" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; color: #606266;">ÂåÖÂê´Ê†áÁ≠æ (Ëá≥Â∞ë‰∏Ä‰∏™)</label>
                                    <el-select v-model="cond.required_labels" multiple style="width: 100%" filterable placeholder="ÈÄâÊã©Ê†áÁ≠æ">
                                        <el-option v-for="l in scoreRules.labels" :key="l" :label="`${l} (x${scoreRules.label_scores[l] || 1})`" :value="l"></el-option>
                                    </el-select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #606266;">ÊéíÈô§Ê†áÁ≠æ</label>
                                    <el-select v-model="cond.excluded_labels" multiple style="width: 100%" filterable placeholder="ÈÄâÊã©Ê†áÁ≠æ">
                                        <el-option v-for="l in scoreRules.labels" :key="l" :label="`${l} (x${scoreRules.label_scores[l] || 1})`" :value="l"></el-option>
                                    </el-select>
                                </div>
                            </div>
                        </div>
                        
                        <el-button type="danger" text @click="delCondition(idx)">Âà†Èô§</el-button>
                    </div>
                    
                    <!-- Ê∑ªÂä†Êù°‰ª∂ÊåâÈíÆ -->
                    <div style="margin-top: 15px;">
                        <el-button @click="showConditionSelector = true">+ Ê∑ªÂä†Êù°‰ª∂</el-button>
                    </div>
                </div>
            </el-scrollbar>
            
            <template #footer>
                <el-button @click="showCreate = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="saveSub" :loading="saving">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>
        
        <!-- Êù°‰ª∂ÈÄâÊã©ÂØπËØùÊ°Ü -->
        <el-dialog v-model="showConditionSelector" title="ÈÄâÊã©Êù°‰ª∂Á±ªÂûã" width="500px">
            <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                <div v-for="ctype in CONDITION_TYPES" :key="ctype.value" 
                     @click="addCondition(ctype.value); showConditionSelector = false"
                     style="border: 1px solid #dcdfe6; border-radius: 4px; padding: 15px; cursor: pointer; transition: all 0.3s;"
                     @mouseenter="$event.target.style.background = '#f5f7fa'"
                     @mouseleave="$event.target.style.background = 'white'">
                    <div style="font-weight: bold; color: #333;">{{ ctype.label }}</div>
                    <div style="font-size: 12px; color: #909399; margin-top: 5px;">{{ ctype.desc }}</div>
                </div>
            </div>
        </el-dialog>
    </div>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Â§ñÈÉ®ËÑöÊú¨Êñá‰ª∂ -->
    <script src="/static/js/constants.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
