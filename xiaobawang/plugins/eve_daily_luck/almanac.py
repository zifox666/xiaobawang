import datetime


class DailyLuck:
    def __init__(self, user_id):
        self.today = datetime.datetime.today()
        self.iday = self.today.year * 10000 + (self.today.month * 100) + self.today.day
        self.user_id = user_id if user_id is not None else 0

        self.weeks = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"]
        self.directions = ["åŒ—æ–¹", "ä¸œåŒ—æ–¹", "ä¸œæ–¹", "ä¸œå—æ–¹", "å—æ–¹", "è¥¿å—æ–¹", "è¥¿æ–¹", "è¥¿åŒ—æ–¹"]
        self.activities = self.load_activities()
        self.specials = [{}]
        self.tools = []
        self.varNames = []
        self.spaces = self.load_spaces()
        self.ships = self.load_ships()

        self.today_str = self.get_today_string()
        self.direction = self.directions[self.random_custom(self.iday, 2) % len(self.directions)]
        self.chosen_ships = ', '.join(self.pick_random(self.ships, 3))
        self.chosen_spaces = ', '.join(self.pick_random(self.spaces, 2))
        self.goddess_value = self.random_custom(self.iday, 6) % 50 / 10.0
        self.good_events, self.bad_events = self.pick_todays_luck()

    def random_custom(self, dayseed, indexseed):
        # åŠ å…¥ç”¨æˆ·IDå½±å“éšæœºç»“æœ
        user_id_num = hash(self.user_id) % 10000
        n = (dayseed + user_id_num) % 11117
        for i in range(100 + indexseed):
            n = (n * n) % 11113
        return n

    @staticmethod
    def load_activities():
        return [
            {"name": "é«˜å®‰ä»»åŠ¡", "good": "å…¨å‡ºè…¹èƒŒå—æ•Œ", "bad": "æ‹‰æš´åŠ¨è¢«åè·³æ‰çº¿"},
            {"name": "åˆ·å¼‚å¸¸", "good": "ä¼ è¯´ä¸€è·³ç ´100m", "bad": "åˆšæ‹‰æš´åŠ¨å°±æ–­ç½‘"},
            {"name": "è¹²ç«™", "good": "ä»Šå¤©POE2æ›´æ–°ç‰ˆæœ¬", "bad": "é”™è¿‡å—œè¡€å‘ç¦åˆ©"},
            {"name": "æŒ–çŸ¿", "good": "çŸ¿æ¶¨ä»·æ¯”æˆ¿ä»·è¿˜å¿«", "bad": "çº¢æ˜Ÿè¹²é©»åœ°æ˜Ÿé—¨äº†"},
            {"name": "æŒ–å†°", "good": "å°é²¸é±¼é«˜å®‰æŒ‚æœºï¼Œçªå‡ºä¸€ä¸ªå®‰é€¸", "bad": "å•¥ï¼Ÿæ€ä¹ˆåˆè¢«ä¸‰å“¥æ‰“æˆä½å®‰äº†ï¼Ÿ"},
            {"name": "æ‰“è¨æ²™", "good": "ç»Ÿåˆéƒ¨LPåˆæ¶¨ä»·äº†", "bad": "INITåˆæ¥äº†"},
            {"name": "è™«æ´", "good": "é—­ç€çœ¼ç›æ•°é’±", "bad": "å®èˆ¹èµ ä¸æœ‰ç¼˜äºº"},
            {"name": "ç¿»åˆåŒ", "good": "æœ‰äººå¡«é”™æ•°å­—ï¼Œèµšåˆ°äº†", "bad": "æ‰‹ä¸€æŠ–ä¹°äº†ä¸ªå¯¡å¦‡"},
            {"name": "çº¤ç»´", "good": "è·¯ä¸Šæ¡äº†ä¸ªç©ºå ¡", "bad": "ä½ è›‹æ²¡äº†"},
            {"name": "å¤šå¼€", "good": "æ¨ªæ‰«æ•…åœŸä¸è§£é‡Š", "bad": "ä¸å°å¿ƒæ‰“åˆ°è‡ªå·±è¢«ç­’å­éƒ¨ç«¯äº†"},
            {"name": "T1åˆ¶é€ ", "good": "å–ç»™æ–°äººèµšä¸€ä¸ªæ˜¯ä¸€ä¸ª", "bad": "çœŸå½“æ–°äººä¸ä¼šç©åˆ¶é€ å•Š"},
            {"name": "ä¼šæˆ˜", "good": "æ€’æŠ“ä¸€æ¡æ³°å¦", "bad": "äº’è¹²æ˜Ÿé—¨åˆ°åŠå¤œä¸‹çº¿"},
            {"name": "å µé—¨", "good": "æœ‰äººè¿ä¸€èˆ¹PLEXè‡ªåŠ¨å¯¼èˆª", "bad": "è¹²ä¸€æ™šä¸Šç§’ç¡äº†ç„¶åæŸäº†"},
            {"name": "åƒè‚‰", "good": "åˆæœ‰YSTç§’ç¡äº†", "bad": "é‚£ä¸ªæ¶ç‹¼æ˜¯æ°¸åŠ¨è£…è‚‰"},
            {"name": "è€ƒå¤", "good": "æŒ–äº†ä¸€èˆ¹é«˜ç»Ÿ", "bad": "ç¢³ï¼Œç¢³ï¼ŒåˆTMæ˜¯ç¢³"},
            {"name": "KFC", "good": "å…¨å®¶æ¡¶ç½‘ä¸Šè®¢é¤æœ‰ä¼˜æƒ ", "bad": "æ€»ç›‘è¦æŸ¥è´¦"},
            {"name": "ä½å®‰ä»»åŠ¡", "good": "æœ¬åœ°å°±ä¸€äººç®€ç›´å¼€å¿ƒ", "bad": "é‡ä¸€éšè½°ï¼Œèˆ¹è›‹åŒé£"},
            {"name": "è·‘è´§", "good": "è¿™ä¸ªæ—¶é—´æ²¡äººæŠ“ä½ ", "bad": "å‡ºé—¨å°±è¢«å µæ­»äº†"},
            {"name": "åˆ·æ­»äº¡", "good": "PAå…¨å®¶æ¡¶", "bad": "ä½ æ‰“æ­»äº¡ä¸å°±ä¸ºäº†ç›’å­å—"},
            {"name": "T2åˆ¶é€ ", "good": "çŸ¥é“å•¥å«å‡ºè´§æˆ˜äº‰å—", "bad": "åˆ¶é€ æ¯ä¸€ç”Ÿ"},
            {"name": "æ‹†è¿", "good": "å£®å“‰æˆ‘å¤šç‚®å¡”ç¥æ•™", "bad": "POSæ˜¯ç©ºçš„"},
            {"name": "å®ˆå®˜å‘˜", "good": "AMMå…¨æŠ—å¦¥å¦¥çš„", "bad": "å¥½ç»¿çš„ææƒ§æ€ª"},
            {"name": "å·è¿", "good": "ç‚’é¸¡ç‰©æµé«˜æ•ˆç›´è¾¾", "bad": "ç‚’é¸¡ä½ çš„è´§æŸœæ€ä¹ˆç©ºç©ºçš„"},
            {"name": "æ”¶å‰²", "good": "åˆºå®¢soloå°å…‹", "bad": "æ€ä¹ˆå…¨åœ¨æŒ‚é "},
            {"name": "æ‰“æ", "good": "å°±æ˜¯è¦æå‡ºä¸€è‰˜æ³°å¦çš„ç”·äººå•Š", "bad": "çªç„¶åˆ·ä¸ªæ€ªæ²¡çœ‹è§ï¼ŒæŸ"},
            {"name": "ä½å®‰è§‚å…‰", "good": "æµ·ç›—éƒ½æ²¡èµ·åºŠ", "bad": "ç™½åè¯±å¯¼æ€ä¹ˆåœ¨è„¸ä¸Š"},
            {"name": "00è§‚å…‰", "good": "èµ°éå…¨å®‡å®™", "bad": "è¢«ç‚¸å›å®¶äº†"},
            {"name": "é«˜å®‰å®£æˆ˜", "good": "åˆæœ‰æ–°é²œçš„è‚‰å•¦", "bad": "è¢«ç–¯ç‹‚çš„æ–°äººå›´å‰¿"},
            {"name": "å¸¦è·¯", "good": "sir, this way", "bad": "æˆ‘å·¨èŸ’å‘¢"},
            {"name": "è¡Œæ˜Ÿå¼€å‘", "good": "ä¸€ç‰‡èŒ«èŒ«ç™½è‰²åŒº", "bad": "è¾›è‹¦åŠå¤©ä¸å¦‚åˆ«äººä¸€é¡¿KFC"},
            {"name": "å‘æ˜", "good": "10æ¡çº¿çº¢äº†9æ¡ï¼Œè¿˜éƒ½æ˜¯Næµç¨‹çš„", "bad": "æˆ‘å›¾å‘¢"},
            {"name": "ä¼æœ¨è¿è´§", "good": "å µé—¨å…šæ²¡ä¸Šç­", "bad": "COSPLAY ğŸ–"},
            {"name": "æŒ–æ°”äº‘", "good": "ä½è°ƒçš„æš´åˆ©è¡Œä¸š", "bad": "æ²¡äººä¹°è¯"},
            {"name": "æ·±æ¸Š", "good": "ä¸€è¶Ÿåäº¿ä¸æ˜¯æ¢¦", "bad": "â€œæ¯’èœ¥ï¼Œæˆ‘çš„æ¯’èœ¥â€"},
            {"name": "è£…å¤‡çªå˜", "good": "ä¸€å·å®˜å‘˜æœ‰æˆ‘å¼ºï¼Ÿ", "bad": "é†’é†’ï¼Œå·¥å¤´å«ä½ æ¬ç –äº†"},
            {"name": "æ·±æ¸Šç«æŠ€åœº", "good": "å¤§å‰å¤§åˆ©ï¼Œä»Šæ™šåƒé¸¡", "bad": "æˆ‘åœ¨å“ªå„¿ï¼Ÿè°åœ¨æ‰“æˆ‘ï¼Ÿæˆ‘æ€ä¹ˆæ­»äº†"},
            {"name": "ç»•æ†å­", "good": "é—·å£°å‘å¤§è´¢", "bad": "å«é˜ŸLPè¢«å‹æˆè¿™æ ·è¿˜ç»•ä¸ªè›‹"},
            {"name": "æ³¡è¯­éŸ³", "good": "å“Ÿï¼ŒèŒå¦¹å­", "bad": "ç»™æ–°äººè®²è§£äº†åŠå¤©å¯¹æ–¹è¡¨ç¤ºåˆšç¡ç€äº†"},
            {"name": "DOTA2", "good": "å¦¹å­æ”¾ä¸€è¾¹ï¼ŒåŸºå‹å›´ä¸€åœˆ", "bad": "æ³¨å®šå­¤ç‹¬ä¸€ç”Ÿ"},
            {"name": "FF14", "good": "åéª‘é˜Ÿï¼Œè¿›ç»„ï¼ŒROLLç‚¹ï¼Œ99", "bad": "ä¸ºä»€ä¹ˆä¸­é—´æœ‰æ¿€å…‰æ‰«è¿‡å•Šå•Šå•Šå•Šå•Šå•Šå•Š"},
            {"name": "å¦å…‹ä¸–ç•Œ", "good": "æˆ‘ä»¬å‡»ç©¿äº†å¯¹æ–¹è£…ç”²", "bad": "è¯¯å›½"},
            {"name": "æŒºé’ˆé˜Ÿ", "good": "0å°å…‰å¤´", "bad": "æˆ‘æ€ä¹ˆå¼€çš„å›è½¬Ved"},
            {"name": "æ‰«è´§", "good": "ç‰ˆæœ¬åƒé‡Œçœ¼è´¢å¯Œå¯†ç ", "bad": "PLEXåˆè·Œäº†"},
            {"name": "è´´å§", "good": "è´´å§æ‰æ˜¯æœ¬ä½“", "bad": "åˆ«æ°´äº†ï¼Œå†æ°´ç»“æ„éƒ½è¦æ²¡äº†"},
            {"name": "ç‚’è´§", "good": "æ°´ç¡¼ç ‚æˆ‘ä¼šä¹±è¯´ï¼Ÿ", "bad": "è¿˜è½®å¾—åˆ°ä½ ä¹ˆ"},
            {"name": "Bç«™", "good": "ä¸“æ³¨æ–°ç•ªä¸‰åå¹´", "bad": "åˆ‡å›æ¥å°±åªå‰©è›‹äº†"},
            {"name": "åŸç¥å¯åŠ¨", "good": "å•æŠ½å‡ºå¥‡è¿¹", "bad": "648æ²¡äº†"},
            {"name": "æ°´ä¸­æ–‡", "good": "æ°´ä¹Ÿæ˜¯ä¸€é—¨è‰ºæœ¯", "bad": "åˆå¿˜äº†æŠŠæœ¬åœ°æ‹‰å‡ºæ¥äº†"},
        ]

    @staticmethod
    def load_spaces():
        return ['è¡€è„‰', 'å¾·å…‹å»‰', 'æ–å¾·', 'å¯¹èˆä¹‹åŸŸ', 'é»‘æ¸Š', 'ç‰¹çº³', 'ç‰¹å¸ƒç‰¹', 'é™å¯‚è°·',
                'ç»´çº³å°”', 'åœ°çª–', 'å¡å½»', 'æŸ¯å°”æ–¯', 'åº•ç‰¹é‡Œå¾·', 'åŸƒç´¢ç‰¹äºš', 'éå¡”æ³¢åˆ©æ–¯', 'å¤§è’é‡',
                'ä¼Šæ¢…ç‘Ÿäºš', 'ç»å¾„', 'å› æ–¯å§†å°”', 'æ¬§ç±³æ–¯ç‰¹', 'æ‘„é­‚ä¹‹åŸŸ', 'æ™®ç½—ç»´ç™»æ–¯', 'ç¼çƒ­ä¹‹å¾„', 'æ··æµŠ',
                'ç‰¹é‡Œè²æ–¯',
                'é‚ªæ¶æ¹¾æµ', 'äº‘ç¯', 'ç»åœ°ä¹‹åŸŸ', 'æºæ³‰ä¹‹åŸŸ', 'å¤–ç¯', 'è´æ–¯', 'é€‘ç‘æ–¯', 'è¾›è¿ªåŠ ',
                'åŸŸå¤–èµ°å»Š',
                'ç‰è“ä¹‹ç©¹', 'å¡å‹’ç“¦æ‹‰é˜”åœ°', 'æ¬§è', 'é’´è“è¾¹åŸŸ', 'ç³Ÿç²•ä¹‹åŸŸ', 'ä½©åˆ©æ ¹å¼—', 'èºæ—‹ä¹‹åŸŸ']

    @staticmethod
    def load_ships():
        return ["åˆ†è£‚è€…çº§", "çˆ†å‘çº§", "æ¢ç´¢çº§", "è£‚è°·çº§", "ä¼æœ¨è€…çº§", "å®ˆå¤œè€…çº§", "é˜¿ç‰¹é¾™çº§", "ä¼Šç±³å¡æ–¯çº§",
                "å› å¡è¨æ–¯çº§",
                "æ¯›é²æ–¯çº§", "çº³ç»´è¾¾æ–¯çº§", "ç‰¹é‡Œæ–¯å¦çº§", "ç£¨éš¾çº§", "åˆ½å­æ‰‹çº§", "æ£€å¯Ÿå®˜çº§", "æƒ©ç½šè€…çº§", "å·¨ç¥å…µçº§",
                "çŸ®è„šé¸¡çº§",
                "ç§ƒé¹«çº§", "ç‹®é¹«çº§", "è‹é¹­çº§", "èŒ¶éš¼çº§", "å°é¹°çº§", "åˆ©çˆªçº§", "çŸ­å‰‘çº§", "é˜¿ç‘æ–¯çº§", "å¡”çº³å°¼æ–¯çº§",
                "åå­—å†›çº§",
                "å’’ç­çº§", "é»‘é¸¦çº§", "çŒ›ç¦½çº§", "ç¾æ´²è™çº§", "çŒç‹¼çº§", "æ©å°¤çº§", "ä¼Šä»€åº“å°”çº§", "å®¡åˆ¤è€…çº§", "å¤ä»‡çº§",
                "å¥³å¦–çº§",
                "æˆ˜é¹°çº§", "çŒè±¹çº§", "çŒçŠ¬çº§", "å¤ªé˜³ç¥çº§", "çº³ç¾è¥¿æ–¯çº§", "å’’é€çº§", "å‡€åŒ–çº§", "ç§ƒé¹°çº§", "èå°¾æ€ªçº§",
                "åœŸç‹¼çº§",
                "å…‹å‹’æ–¯çº§", "å“¨å…µçº§", "æ–¯èŠ¬å°¼å…‹æ–¯çº§", "é•¿å°¾é²›çº§", "ä¿ƒè¿›çº§", "å¼ºåˆ¶è€…çº§", "æµ·ç‡•çº§", "å‰‘é½¿è™çº§",
                "å„é‡Œæ–¯çº§",
                "å¼‚ç«¯çº§", "é£ç‡•çº§", "æŒ‘æˆ˜çº§", "æ–­å´–çº§", "é•°åˆ€çº§", "åˆºå®¢çº§", "æ˜Ÿç©ºçº§", "é€è‘¬è€…çº§", "æ‰˜å‹’å…‹æ–¯çº§",
                "ç‹‚æ€’è€…çº§",
                "ä¸»å®°çº§", "å¥¥æ ¼è¯ºçº§", "æ—è«çº§", "å¯ç¤ºçº§", "é»‘é¸Ÿçº§", "ç‹ç¾çº§", "å·¨é¸Ÿçº§", "é±¼é¹°çº§", "ä¼‘æ´¥çº§", "é•¿å‰‘çº§",
                "åŸƒæ‹‰å…¹çº§", "æ‹‰å…‹å¸Œæ–¯çº§", "è¯…å’’çº§", "æœåœ£çº§", "æˆ˜éš¼çº§", "ç™½å˜´é¸¦çº§", "é˜”åˆ€çº§", "ä¼æ³¢æ–¯çº§", "å¥‰çŒ®çº§",
                "å¥¥å°¼å…‹æ–¯çº§", "ç¼ªå®çº§", "æµæµªçº§", "æˆ´é»˜æ–¯çº§", "ä¼Šä»€å¡”çº§", "æ¸åœ£çº§", "ç‹‚çƒ­çº§", "å¸Œå°”åšæ‹‰æ–¯çº§", "é“¶é¹°çº§",
                "æ›²å‰‘çº§", "å¥¥å†…ç½—æ–¯çº§", "å®ˆå«çº§", "çš‡å† èœ¥çº§", "é£“é£çº§", "æš´é£çº§", "å¸ƒé²æå…‹æ–¯çº§", "å¼¥æ´±ç±³é¡¿çº§",
                "å…ˆçŸ¥çº§",
                "å…ˆé©±è€…çº§", "çŒ›é²‘çº§", "å¹¼é¾™çº§", "æœˆåˆƒçº§", "æ–¯é›·æ™®å°¼çº§", "é˜¿æ–½å¡”ç‰¹çº§", "æ›™å…‰å¥³ç¥çº§", "æ•‘èµçº§", "æ°¸ç­çº§",
                "å¤œé¹°çº§", "å…€é¹«çº§", "ç‹‚æš´çº§", "å°é£çº§", "æ­»äº¡æ¼©æ¶¡çº§", "å¤šç±³å°¼å…‹æ–¯çº§", "ä¸‡ç‹å®åº§çº§", "äº¥ä¼¯é¾™ç¥çº§",
                "ç¾éš¾çº§",
                "æœ«æ—¥æ²™åœºçº§", "åœ°ç‹±å¤©ä½¿çº§", "ä¹Œé¸¦çº§", "æ¯’èçº§", "é¹é²²çº§", "é»‘è±¹çº§", "ç½ªæ¶çº§", "æ•‘ä¸–çº§", "å¯¡å¦‡çº§",
                "æ¶ç‹¼çº§",
                "å…‹æ´›è¯ºæ–¯çº§", "å¸•æ‹‰ä¸çº§", "é­”åƒçº§", "æ‹‰æ ¼çº³æ´›å…‹çº§", "ä¿„æ´›å·´æ–¯çº§", "ç¥ä½¿çº§", "å‹’ç»´äºšå¦çº§", "çº³è¿¦æ³•çº§",
                "è«æ´›çº§",
                "ç¥ç¤ºçº§", "å‡¤å‡°çº§", "å†¥åºœçº§", "å°¼é“æ ¼å°”çº§", "å¤œç¥çº§", "ç»å¿µçº§", "ä¸‡å¤çº§", "æ‰§æ”¿å®˜çº§", "å¥‡ç¾æ‹‰çº§",
                "é£é¾™çº§",
                "å·¨è±¡çº§", "å¾˜å¾Šè€…çº§", "å¥¥å¡æ‰˜çº§", "æ—…è¡Œè€…çº§", "æ¿€è¿›çº§", "åˆ†è£‚çº§", "å¤§é¸¨çº§", "å¤©é¹¤çº§",
                "é˜¿æ–¯ç‰¹ç½—çº§", "æ–¯ç‰¹ä¿®æ–¯çº§", "æ¶…æ–¯æ‰˜çº§", "åŠ å§†çº§", "å¥¥è‹æ–¯çº§", "å·´ç›–æ–¯çº§", "è¾¾ç›ç»´å…‹çº§", "å¥‡å¥‡è«æ‹‰çº§",
                "ç»´å¾·é©¬å…‹çº§", "å¾·é›·å¡ç“¦çº§", "å‹’æ²™å…‹çº§"]

    def get_today_string(self):
        return f"ä»Šå¤©æ˜¯ {self.today.year}å¹´{self.today.month}æœˆ{self.today.day}æ—¥ æ˜ŸæœŸ{self.weeks[self.today.weekday()]}"

    def pick_todays_luck(self):
        num_good = self.random_custom(self.iday, 98) % 3 + 2
        num_bad = self.random_custom(self.iday, 87) % 3 + 2
        event_arr = self.pick_random_activity(num_good + num_bad)

        good_events = event_arr[:num_good]
        bad_events = event_arr[num_good:num_good + num_bad]

        return good_events, bad_events

    def pick_random_activity(self, size):
        picked_events = self.pick_random(self.activities, size)
        return [self.parse(event) for event in picked_events]

    def pick_random(self, array, size):
        result = list(array)
        for j in range(len(array) - size):
            index = self.random_custom(self.iday, j) % len(result)
            result.pop(index)
        return result

    def parse(self, event):
        result = event.copy()
        if '%v' in result['name']:
            result['name'] = result['name'].replace('%v', self.varNames[
                self.random_custom(self.iday, 12) % len(self.varNames)])
        if '%t' in result['name']:
            result['name'] = result['name'].replace('%t',
                                                    self.tools[self.random_custom(self.iday, 11) % len(self.tools)])
        if '%l' in result['name']:
            result['name'] = result['name'].replace('%l', str(self.random_custom(self.iday, 12) % 247 + 30))
        return result

    def get_luck_level(self):
        value = self.goddess_value
        if value >= 4.0:
            return "å¤§å‰"
        elif value >= 3.5:
            return "ä¸­å‰"
        elif value >= 2.5:
            return "å°å‰"
        elif value >= 1.0:
            return "å¹³å¹³æ— å¥‡"
        elif value >= 0.5:
            return "å°å‡¶"
        else:
            return "å¤§å‡¶"


