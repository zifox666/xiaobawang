<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EVE å»ºç­‘é€šçŸ¥ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' };</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <script>
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            document.documentElement.classList.toggle('dark', e.matches);
        });
    </script>

    <div class="max-w-3xl mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6 text-center">ğŸ—ï¸ EVE å»ºç­‘é€šçŸ¥ç®¡ç†</h1>

        <!-- â”€â”€ æœªç™»å½•: æ˜¾ç¤ºæˆæƒæŒ‰é’® â”€â”€ -->
        <div id="login-section" class="text-center py-16">
            <p class="text-gray-500 dark:text-gray-400 mb-6">ä½¿ç”¨ EVE Online è´¦å·æˆæƒä»¥ç®¡ç†å»ºç­‘é€šçŸ¥æ¨é€</p>
            <button id="login-btn"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition inline-flex items-center gap-2 text-base">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd"/>
                </svg>
                ä½¿ç”¨ EVE Online æˆæƒ
            </button>
            <p class="mt-3 text-xs text-gray-400">æˆæƒåä»…å¯¹æ‚¨æœ¬äººå¯è§</p>
            <div id="login-error" class="mt-4 text-red-500 text-sm hidden"></div>
        </div>

        <!-- â”€â”€ å·²ç™»å½•: ç®¡ç†é¢æ¿ â”€â”€ -->
        <div id="main-section" class="hidden">
            <!-- è§’è‰²ä¿¡æ¯ -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 mb-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="char-portrait" class="w-10 h-10 rounded-full" src="" alt="" />
                    <div>
                        <p class="font-medium" id="char-name"></p>
                        <p class="text-xs text-gray-400" id="char-id"></p>
                    </div>
                </div>
                <button id="logout-btn"
                        class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition">
                    åˆ‡æ¢è§’è‰²
                </button>
            </div>

            <!-- æµç¨‹è¯´æ˜ -->
            <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6 text-sm">
                <p class="font-semibold mb-2">ä½¿ç”¨æµç¨‹:</p>
                <ol class="list-decimal list-inside space-y-1">
                    <li>å‹¾é€‰éœ€è¦æ¥æ”¶çš„é€šçŸ¥ç±»åˆ«</li>
                    <li>ç‚¹å‡»ã€Œç”ŸæˆéªŒè¯ç ã€è·å–éªŒè¯ç </li>
                    <li>åœ¨ç›®æ ‡èŠå¤©ä¸­å‘é€ <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">/verify éªŒè¯ç </code> ç»‘å®šä¼šè¯</li>
                </ol>
            </div>

            <!-- é€‰æ‹©ç±»åˆ« -->
            <section class="mb-6">
                <h2 class="text-lg font-semibold mb-3">é€‰æ‹©é€šçŸ¥ç±»åˆ«</h2>
                <div id="categories-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
            </section>

            <!-- ç”ŸæˆéªŒè¯ç  -->
            <section class="mb-6">
                <button id="gen-code-btn"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">
                    ç”ŸæˆéªŒè¯ç 
                </button>
                <div id="verify-code-display" class="mt-3 hidden">
                    <p class="text-sm text-gray-500 dark:text-gray-400">è¯·åœ¨ç›®æ ‡èŠå¤©ä¸­å‘é€ä»¥ä¸‹å‘½ä»¤:</p>
                    <div class="mt-1 flex items-center gap-2">
                        <code id="verify-code-text"
                              class="text-lg font-mono bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded select-all"></code>
                        <button id="copy-btn"
                                class="text-sm px-2 py-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 rounded transition">
                            å¤åˆ¶
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">éªŒè¯ç  10 åˆ†é’Ÿå†…æœ‰æ•ˆ</p>
                </div>
            </section>

            <hr class="border-gray-200 dark:border-gray-700 my-8" />

            <!-- å·²æœ‰è®¢é˜… -->
            <section>
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">å·²æœ‰è®¢é˜…</h2>
                    <div class="flex items-center gap-3">
                        <span id="subs-updated" class="text-xs text-gray-400 hidden"></span>
                        <button id="refresh-subs-btn"
                                class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition flex items-center gap-1">
                            <svg id="refresh-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div id="subscriptions-container">
                    <p class="text-gray-400 text-sm">åŠ è½½ä¸­â€¦</p>
                </div>
            </section>
        </div>
    </div>

    <script>
        const BASE = window.location.pathname.replace(/\/page\/?$/, '');
        let authToken = null;

        // â”€â”€ ä» URL å‚æ•°æˆ– localStorage æ¢å¤ token â”€â”€
        const params = new URLSearchParams(window.location.search);
        if (params.get('token')) {
            authToken = params.get('token');
            localStorage.setItem('struct_notify_token', authToken);
            history.replaceState(null, '', window.location.pathname);
        } else {
            authToken = localStorage.getItem('struct_notify_token');
        }
        if (params.get('error')) {
            document.getElementById('login-error').textContent = 'æˆæƒå¤±è´¥: ' + decodeURIComponent(params.get('error'));
            document.getElementById('login-error').classList.remove('hidden');
        }

        /** æ„é€ å¸¦ token çš„ API URL */
        function apiUrl(path) {
            const url = new URL(`${BASE}${path}`, window.location.origin);
            if (authToken) url.searchParams.set('token', authToken);
            return url.toString();
        }

        // â”€â”€ æ£€æŸ¥ç™»å½•çŠ¶æ€ â”€â”€
        async function checkAuth() {
            if (!authToken) { showLogin(); return; }
            try {
                const res = await fetch(apiUrl('/api/auth/me'));
                if (!res.ok) throw new Error('unauthorized');
                const json = await res.json();
                if (json.code !== 200) throw new Error(json.msg);
                showMain(json.data);
            } catch {
                localStorage.removeItem('struct_notify_token');
                authToken = null;
                showLogin();
            }
        }

        let _pollTimer = null;

        function startPolling() {
            stopPolling();
            _pollTimer = setInterval(loadSubscriptions, 1000);
        }

        function stopPolling() {
            if (_pollTimer !== null) { clearInterval(_pollTimer); _pollTimer = null; }
        }

        function showLogin() {
            stopPolling();
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-section').classList.add('hidden');
        }

        function showMain(user) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('char-name').textContent = user.character_name;
            document.getElementById('char-id').textContent = 'ID: ' + user.character_id;
            document.getElementById('char-portrait').src =
                `https://images.evetech.net/characters/${user.character_id}/portrait?size=64`;
            loadCategories();
            loadSubscriptions();
            startPolling();
        }

        // â”€â”€ ç™»å½• â”€â”€
        document.getElementById('login-btn').addEventListener('click', async () => {
            try {
                const res = await fetch(`${BASE}/api/auth/url`, { method: 'POST' });
                const json = await res.json();
                if (json.code !== 200) throw new Error(json.msg);
                window.location.href = json.data.auth_url;
            } catch (e) {
                alert('è·å–æˆæƒé“¾æ¥å¤±è´¥: ' + e.message);
            }
        });

        // â”€â”€ ç™»å‡º / åˆ‡æ¢è§’è‰² â”€â”€
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('struct_notify_token');
            authToken = null;
            showLogin();
        });

        // â”€â”€ åŠ è½½ç±»åˆ« â”€â”€
        let categoriesData = [];
        async function loadCategories() {
            const res = await fetch(apiUrl('/api/categories'));
            const json = await res.json();
            categoriesData = json.data || [];
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            categoriesData.forEach(cat => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition';
                label.innerHTML = `
                    <input type="checkbox" value="${cat.key}" class="cat-checkbox w-4 h-4 text-blue-600 rounded"
                           ${cat.key === 'structure' ? 'checked' : ''} />
                    <span class="text-sm">${cat.label}
                        <span class="text-xs text-gray-400">(${cat.types.length})</span>
                    </span>`;
                container.appendChild(label);
            });
        }

        function getSelectedCategories() {
            return [...document.querySelectorAll('.cat-checkbox:checked')].map(el => el.value);
        }

        // â”€â”€ åŠ è½½è®¢é˜… â”€â”€
        async function loadSubscriptions() {
            const container = document.getElementById('subscriptions-container');
            // åªæœ‰é¦–æ¬¡ï¼ˆå®¹å™¨ä¸ºç©ºï¼‰æ—¶æ‰æ˜¾ç¤ºã€ŒåŠ è½½ä¸­ã€ï¼Œè½®è¯¢æ—¶é™é»˜åˆ·æ–°
            if (!container.children.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm">åŠ è½½ä¸­â€¦</p>';
            }
            // åˆ·æ–°å›¾æ ‡æ—‹è½¬åŠ¨ç”»
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('animate-spin');
            try {
                const res = await fetch(apiUrl('/api/subscriptions'));
                const json = await res.json();
                const subs = json.data || [];
                if (!subs.length) {
                    container.innerHTML = '<p class="text-gray-400 text-sm">æš‚æ— è®¢é˜…ï¼Œè¯·å…ˆç”ŸæˆéªŒè¯ç å¹¶åœ¨èŠå¤©ä¸­ç»‘å®š</p>';
                    return;
                }
                container.innerHTML = '';
                subs.forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 mb-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800';
                    const cats = (sub.categories || []).join(', ');
                    div.innerHTML = `
                        <div class="text-sm">
                            <p>
                                <span class="font-medium">${sub.session_id}</span>
                                <span class="text-xs text-gray-400">${sub.platform} / ${sub.session_type}</span>
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">ç±»åˆ«: ${cats}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="testPush(${sub.id})"
                                class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 transition">
                                æµ‹è¯•æ¨é€
                            </button>
                            <button onclick="toggleSub(${sub.id}, ${!sub.is_enabled})"
                                class="text-xs px-2 py-1 rounded ${sub.is_enabled
                                    ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
                                    : 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400'}">
                                ${sub.is_enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                            </button>
                            <button onclick="deleteSub(${sub.id})"
                                class="text-xs px-2 py-1 rounded bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 transition">
                                åˆ é™¤
                            </button>
                        </div>`;
                    container.appendChild(div);
                });
            } catch (e) {
                container.innerHTML = `<p class="text-red-500 text-sm">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            } finally {
                icon.classList.remove('animate-spin');
                const ts = document.getElementById('subs-updated');
                ts.textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString();
                ts.classList.remove('hidden');
            }
        }

        document.getElementById('refresh-subs-btn').addEventListener('click', loadSubscriptions);

        // â”€â”€ ç”ŸæˆéªŒè¯ç  â”€â”€
        document.getElementById('gen-code-btn').addEventListener('click', async () => {
            const cats = getSelectedCategories();
            if (!cats.length) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é€šçŸ¥ç±»åˆ«');
            try {
                const res = await fetch(apiUrl('/api/verify_code'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories: cats }),
                });
                const json = await res.json();
                if (json.code !== 200) throw new Error(json.msg);
                document.getElementById('verify-code-text').textContent = `/verify ${json.data.code}`;
                document.getElementById('verify-code-display').classList.remove('hidden');
            } catch (e) {
                alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
            }
        });

        document.getElementById('copy-btn').addEventListener('click', () => {
            const text = document.getElementById('verify-code-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('copy-btn').textContent = 'å·²å¤åˆ¶ âœ“';
                setTimeout(() => { document.getElementById('copy-btn').textContent = 'å¤åˆ¶'; }, 1500);
            });
        });

        // â”€â”€ åˆ‡æ¢ / åˆ é™¤è®¢é˜… â”€â”€
        async function toggleSub(subId, enabled) {
            await fetch(apiUrl(`/api/subscriptions/${subId}`), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_enabled: enabled }),
            });
            loadSubscriptions();
        }

        async function deleteSub(subId) {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è®¢é˜…?')) return;
            await fetch(apiUrl(`/api/subscriptions/${subId}`), { method: 'DELETE' });
            loadSubscriptions();
        }

        async function testPush(subId) {
            try {
                const res = await fetch(apiUrl(`/api/subscriptions/${subId}/test`), { method: 'POST' });
                const json = await res.json();
                if (json.code !== 200) throw new Error(json.msg);
                alert('æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼Œè¯·åˆ°èŠå¤©ä¸­æŸ¥çœ‹');
            } catch (e) {
                alert('æµ‹è¯•æ¨é€å¤±è´¥: ' + e.message);
            }
        }

        // â”€â”€ å¯åŠ¨ â”€â”€
        checkAuth();
    </script>
</body>
</html>
